% =================== 推荐的修正和优化 ===================
clear all; % 彻底清除工作区，避免变量名冲突
clc;       % 清空命令行窗口
% 输入数据
data = [1.268628166	1	0	8.382909946
1.272067179	1	1	4.400155782
0.47548875	1	0	0.573488911
1.483772647	1	0	19.33372407
1.137829486	1	0	7.12845202
1.476191477	1	0	10.45231252
1.000702727	1	0	2.574284897
1.252802671	3	1	0.736596969
1.373216743	2	1	2.806913982
0.833985	2	1	4.817006366
1.096578428	1	0	1.84917177
0.833985	1	0	0.764704657
1.459198977	2	0	83.09785542
1.170022295	3	0	9.906328215
0.87548875	2	1	0.279959604
0.3	1	1	0.129600422
0.4	1	0	0.280429608
1.137829486	2	0	101.4606972
1.418817671	2	0	88.31474968
1.326238852	2	0	3.54120953
1.539100019	2	0	7.490340896
1.417695227	2	0	5.661859974
0.47548875	2	0	0.132416226
1.096578428	2	0	34.35669016
1.326238852	2	0	86.98224472
1	2	0	20.68229399
1.268628166	2	0	3.338786992
1.588149638	3	0	9.995308351
1.391370754	2	0	11.29015193
0.942206477	1	0	4.350705257
1.000702727	2	0	4.993723232
1.322239242	2	0	13.18534965
0.87548875	2	0	9.645010235
1.498572337	2	0	6.534824982
1.539100019	2	0	11.3862143
1.0509775	1	0	9.052582067
1.409473751	2	0	5.536265073
1.070274988	3	2	1.878958515
1.326238852	2	0	13.1086562
1.170022295	2	0	7.324638084
1.683362208	3	1	7.773358743
1.432874504	3	0	11.75892763
1.367742602	2	0	4.709637058
1.551653107	4	0	22.07626052
1.3	2	0	14.59987937
1.111526045	1	0	4.55094989
0.933985	1	0	7.054615943
0.796578428	1	1	1.090253828
0.3	1	0	0.403941253
1.409473751	3	0	9.836503462
1.572409413	3	0	17.51666571
0.933985	2	0	8.213311741
1.384735102	2	0	1.581823786
1.391370754	2	1	1.316074768
0.47548875	1	0	0.886757852
0.47548875	1	0	0.631259933
1.373216743	1	0	6.687381111
0.696578428	3	1	4.654821044
1.34150375	2	0	28.34735066
1.096578428	2	0	8.380175993
0.796578428	1	0	0.457342994
0.3	1	0	0.361723232
1.137829486	2	1	1.631140414
0.57548875	1	0	0.115966067
1.096325736	1	0	0.863503063
1.343231353	2	1	3.558247482
1.568628166	4	1	28.1768535
1.232371158	1	0	2.249460608
1.3	2	2	1.80093786
1.268628166	1	0	4.054748507
1.272067179	1	0	4.357376581
0.3	1	0	0.479518293
1.428771238	3	0	3.620504651
0.95849625	4	1	0.864287431
0.7	1	0	0.627240047
0.47548875	1	0	0.14756048
1.242324725	1	0	3.085566477
1.128771238	1	0	2.852175407
1.3	2	0	4.544779769
1.491391786	5	2	2.784263031
1.434687727	3	1	4.224057931
1.726238852	6	3	5.067760717
1	3	2	1.038164496
1.096578428	2	0	1.122390674
1.000702727	2	0	0.401730811
1.322239242	1	0	5.041219411
1.20768156	2	0	2.725518582
1.322239242	2	0	5.679866505
1.215903036	2	0	5.323313218
1.510149357	5	0	14.21707503
1.60333746	4	0	16.16913863
0.7	1	0	0.922862423
1.551653107	2	0	2.36118841
1.596510222	3	1	8.601402276
1.294306421	2	0	18.46766972
1.096578428	1	1	28.79738891
1.294306421	1	0	15.04945806
1.348478095	2	0	30.94210849
1.521431912	3	0	19.24621868
1.210131915	3	0	3.210769626
0.3	1	0	0.023167666
0.796578428	2	0	0.347107695
0.3	1	0	0.258411267
1.128771238	2	0	0.304982025
1.096325736	2	0	3.327987901
1.559198977	2	0	6.093000327
0.942206477	2	1	0.253509288]; % 最后一行

% 获取行数列数
[n, m] = size(data);

% ===== 1. 指标正向化 =====
% 关键修复：cost_benefit必须与指标数量(m)一致
cost_benefit = [1, 1, 1, 1]; % 1=效益型, 0=成本型 
% 说明：根据您的指标含义设置

for col = 1:m
    if cost_benefit(col) == 0 % 成本型指标
        max_val = max(data(:, col));
        data(:, col) = max_val - data(:, col); % 转换为效益型
    end
end
disp("正向化后的矩阵:");
disp(data);

% ===== 2. 数据标准化 =====
% 极差法标准化（推荐）
for j = 1:m
    min_val = min(data(:, j));
    max_val = max(data(:, j));
    range_val = max_val - min_val;
    
    if range_val == 0
        data(:, j) = 0.5;
    else
        data(:, j) = (data(:, j) - min_val) / range_val;
    end
end
disp("标准化后的矩阵:");
disp(data);

% ===== 3. 权重设置 =====
% 关键修改：权重向量必须与指标数量(m)一致
w = [0.315710565830655	0.195579146224728	0.257400926013331	0.231309361931285]; % 

% 确保权重和为1：sum(w) ≈ 1

% ===== 4. TOPSIS计算 =====
% 加权决策矩阵
W = data .* w; % 注意：w必须是行向量

% 确定理想解
Z = max(W);   % 正理想解
F = min(W);   % 负理想解

% 计算距离
D_pos = sqrt(sum((W - Z).^2, 2));
D_neg = sqrt(sum((W - F).^2, 2));

% 计算相对接近度
C = D_neg ./ (D_pos + D_neg);

% 排序
[~, rank] = sort(C, 'descend');

% ===== 5. 结果输出 =====
fprintf('\nTOPSIS综合评价结果:\n');
fprintf('样本  接近度C  排名\n');
for i = 1:n
    fprintf('%2d    %.4f   %2d\n', i, C(i), find(rank==i));
end

fprintf('\n样本排序(从优到劣): ');
fprintf('%d ', rank);
fprintf('\n');

% ===== 6. 可视化 =====
figure;
barh(1:n, C(rank), 'FaceColor', [0.2 0.6 0.8]);

% 生成样本标签
labels = arrayfun(@(x) sprintf('样本%d', x), rank, 'UniformOutput', false);

set(gca, 'YTick', 1:n, 'YTickLabel', labels);
title('TOPSIS综合评价结果');
xlabel('相对接近度C');
ylabel('样本');
set(gca, 'YDir', 'reverse'); % 从上到下显示
grid on;

% 添加数据标签
text(C(rank), 1:n, num2str(C(rank), '%.4f'), 'HorizontalAlignment', 'left', ...
    'VerticalAlignment', 'middle', 'FontSize', 8);